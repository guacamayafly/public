<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta content="width=device-width, initial-scale=1" name="viewport" />
  <title>Guacamayafly Booking Page</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
        theme: {
            extend: {
                colors: {
                    'guacamayafly-green': '#00c897',
                    'guacamayafly-dark-green': '#00b386',
                    'guacamayafly-orange': '#FF7F00',
                    'guacamayafly-dark-orange': '#E67300',
                }
            }
        }
    }
  </script>
  <link
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css"
    rel="stylesheet"
  />
  <link
    href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap"
    rel="stylesheet"
  />
  <style>
    body {
      font-family: "Poppins", sans-serif;
    }
    .no-scrollbar::-webkit-scrollbar {
      display: none;
    }
    .no-scrollbar {
      -ms-overflow-style: none;
      scrollbar-width: none;
    }
    .payment-option {
        border: 1px solid #e5e7eb;
        padding: 0.75rem;
        border-radius: 0.5rem;
        cursor: pointer;
        transition: all 0.2s ease;
    }
    .payment-option:hover {
        border-color: #FF7F00;
        background-color: #fff7ed;
    }
    .payment-option.selected {
        border-color: #FF7F00;
        background-color: #fff7ed;
        box-shadow: 0 0 0 2px #FF7F00;
    }
    .payment-logo {
        height: 24px;
    }
    .modal-overlay {
        position: fixed;
        inset: 0;
        background-color: rgba(0,0,0,0.6);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 5000;
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.3s ease;
    }
    .modal-overlay.visible {
        opacity: 1;
        pointer-events: auto;
    }
    .modal-container {
        background-color: white;
        padding: 1.5rem;
        border-radius: 0.75rem;
        box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        width: 90%;
        max-width: 800px;
        transform: scale(0.95);
        transition: transform 0.3s ease;
        display: flex;
        flex-direction: column;
    }
    .modal-overlay.visible .modal-container {
        transform: scale(1);
    }
    .calendar-modal .modal-container {
        padding: 0;
        max-height: 90vh;
        overflow: hidden;
        max-width: 400px;
    }
    .calendar-modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 1rem;
        border-bottom: 1px solid #e5e7eb;
    }
    .calendar-modal-top-info {
        display: flex;
        justify-content: space-around;
        padding: 0.5rem 1rem;
        background-color: #f9fafb;
    }
    .info-box {
        text-align: center;
        padding: 0.5rem;
        border-radius: 0.5rem;
        flex: 1;
    }
    .info-box span {
        display: block;
    }
    .info-box .label {
        font-size: 0.75rem;
        color: #6b7280;
    }
    .info-box .value {
        font-weight: 600;
    }
    .calendar-modal-body {
        padding: 1rem;
        overflow-y: auto;
    }
    .calendar-modal-footer {
        padding: 1rem;
        border-top: 1px solid #e5e7eb;
        background-color: white;
        display: flex;
        justify-content: flex-end;
        gap: 1rem;
    }
    .price-legend {
        display: flex;
        justify-content: center;
        gap: 1rem;
        margin-top: 1rem;
        font-size: 0.8rem;
    }
    .price-legend > div { display: flex; align-items: center; gap: 0.5rem; }
    .price-legend .color-box { width: 1rem; height: 1rem; border-radius: 0.25rem; }
    .quick-select-buttons {
        display: flex;
        gap: 1rem;
        margin-top: 1rem;
    }
    .quick-select-buttons button {
        flex: 1;
        padding: 0.5rem;
        border: 1px solid #d1d5db;
        border-radius: 9999px;
        background-color: white;
        cursor: pointer;
        font-weight: 600;
    }
    .quick-select-buttons button:hover { background-color: #f3f4f6; }

    .calendar-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; }
    .calendar-months { display: grid; grid-template-columns: 1fr; gap: 2rem; }
    @media (min-width: 768px) { .calendar-months { grid-template-columns: 1fr 1fr; } }
    .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 0.25rem; place-items: center; }
    .calendar-day { width: 38px; height: 38px; display: flex; justify-content: center; align-items: center; border-radius: 50%; cursor: pointer; transition: all 0.2s; }
    .calendar-day.weekday { font-weight: 600; font-size: 0.8rem; color: #4a5568; cursor: default; }
    .calendar-day.disabled { color: #cbd5e0; cursor: not-allowed; text-decoration: line-through; }
    .calendar-day:not(.disabled):not(.weekday):hover { background-color: #f0f0f0; }
    .calendar-day.price-cheap { background-color: #d1fae5; color: #065f46; }
    .calendar-day.price-medium { background-color: #fef3c7; color: #92400e; }
    .calendar-day.price-expensive { background-color: #fee2e2; color: #991b1b; }
    .calendar-day.selected { background-color: #FF7F00 !important; color: white !important; font-weight: bold; }
    .calendar-day.in-range { background-color: #fff7ed; border-radius: 0; }
    .calendar-day.range-start { border-top-left-radius: 50%; border-bottom-left-radius: 50%; }
    .calendar-day.range-end { border-top-right-radius: 50%; border-bottom-right-radius: 50%; }

    #notification-container { position: fixed; top: 20px; right: 20px; z-index: 10000; }
    .notification-popup { background-color: #ef4444; color: white; padding: 1rem 1.5rem; border-radius: 0.5rem; font-weight: 600; box-shadow: 0 4px 12px rgba(0,0,0,0.15); transform: translateX(120%); transition: transform 0.5s ease-in-out; margin-top: 10px; }
    .notification-popup.show { transform: translateX(0); }

    #development-popup-overlay {
        position: fixed;
        inset: 0;
        background-color: rgba(0,0,0,0.6);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 12000;
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.3s ease;
    }
    #development-popup-overlay.visible {
        opacity: 1;
        pointer-events: auto;
    }
    #development-popup-overlay .modal-container {
        background-color: white;
        padding: 2rem;
        border-radius: 0.75rem;
        box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        width: 90%;
        max-width: 400px;
        transform: scale(0.95);
        transition: transform 0.3s ease;
        display: flex;
        flex-direction: column;
        text-align: center;
    }
    #development-popup-overlay.visible .modal-container {
        transform: scale(1);
    }

    #sticky-reserve-btn-container {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        background-color: white;
        padding: 0.5rem 1.5rem;
        box-shadow: 0 -4px 12px rgba(0,0,0,0.1);
        z-index: 900;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 0.25rem;
        transition: transform 0.3s ease-in-out;
    }

    #sticky-reserve-btn-container.hidden {
        transform: translateY(100%);
    }
    #sticky-reserve-btn {
        width: 100%;
        background-color: #FF7F00;
        color: white;
        font-size: 1.125rem;
        font-weight: bold;
        padding: 0.75rem 1.5rem;
        border-radius: 9999px;
        transition: background-color 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
        position: relative;
        overflow: hidden;
    }
    #sticky-reserve-btn:hover {
        background-color: #E67300;
    }
    
    #sticky-reserve-info {
        font-size: 0.75rem;
        color: #6b7280;
        text-align: center;
    }

    body.has-sticky-footer {
        padding-bottom: 8rem; 
    }

    #date-display-block {
      display: grid;
      grid-template-columns: 1fr auto 1fr auto;
      align-items: center;
      gap-x: 0.5rem;
    }

    #date-display-block .header-cell {
        font-size: 0.75rem;
        color: #6b7280;
        font-weight: 600;
    }

    #date-display-block .date-details {
      display: flex;
      flex-direction: column;
      align-items: flex-start;
    }

    #date-display-block .nights-count {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      flex-shrink: 0;
    }

    @media (min-width: 640px) {
        #date-display-block {
            grid-template-columns: 1fr auto 1fr auto;
        }
    }
    
  </style>
</head>
<body class="bg-[#f7f8fa] text-[#222222]">

  <!-- Mobile Menu Overlay -->
  <div id="mobile-menu-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-40 hidden"></div>

  <!-- Mobile Menu -->
  <div id="mobile-menu" class="fixed top-0 left-0 h-full w-4/5 max-w-sm bg-white shadow-lg p-6 z-50 transform -translate-x-full transition-transform duration-300 ease-in-out">
      <div class="flex justify-between items-center mb-6">
          <div class="flex items-center space-x-2">
            <img alt="Logo Guacamayafly" height="32" src="https://estudioguacamaya.github.io/guacamayafly/logo.svg" width="32"/>
            <span class="font-extrabold text-lg select-none text-guacamayafly-orange">UACAMAYAFLY</span>
          </div>
          <button id="close-mobile-menu" class="text-2xl">Ã—</button>
      </div>
       <button class="w-full bg-blue-600 hover:bg-blue-700 text-white rounded-full py-2 font-semibold mb-4" type="button">Iniciar sesiÃ³n</button>
      <nav class="flex flex-col space-y-4">
          <a href="#" class="text-gray-700 hover:text-guacamayafly-orange">Escribe una opiniÃ³n</a>
          <a href="#" class="text-gray-700 hover:text-guacamayafly-orange">Viajes</a>
          <a href="#" class="text-gray-700 hover:text-guacamayafly-orange">Convierte en anfitriÃ³n</a>
          <hr>
          <h3 class="font-semibold text-gray-500 uppercase text-sm pt-2">CategorÃ­as</h3>
          <a href="#" class="flex items-center gap-3 text-gray-700 hover:text-guacamayafly-orange"><i class="fas fa-building w-5"></i> Hoteles</a>
          <a href="#" class="flex items-center gap-3 text-gray-700 hover:text-guacamayafly-orange"><i class="fas fa-star w-5"></i> Cosas que hacer</a>
          <a href="#" class="flex items-center gap-3 text-gray-700 hover:text-guacamayafly-orange"><i class="fas fa-utensils w-5"></i> Restaurantes</a>
          <a href="#" class="flex items-center gap-3 text-gray-700 hover:text-guacamayafly-orange"><i class="fas fa-plane w-5"></i> Vuelos</a>
          <a href="#" class="flex items-center gap-3 text-gray-700 hover:text-guacamayafly-orange"><i class="fas fa-house-user w-5"></i> Alquileres vacacionales</a>
          <a href="#" class="flex items-center gap-3 text-gray-700 hover:text-guacamayafly-orange"><i class="fas fa-ship w-5"></i> Cruceros</a>
          <a href="#" class="flex items-center gap-3 text-gray-700 hover:text-guacamayafly-orange"><i class="fas fa-car w-5"></i> Coches de alquiler</a>
          <a href="#" class="flex items-center gap-3 text-gray-700 hover:text-guacamayafly-orange"><i class="far fa-comments w-5"></i> Foros</a>
      </nav>
  </div>


  <div id="development-popup-overlay" class="modal-overlay hidden">
      <div class="modal-container">
          <div class="text-yellow-500 mb-4">
              <i class="fas fa-exclamation-triangle fa-3x"></i>
          </div>
          <h2 class="text-2xl font-bold mb-2 text-gray-800">Sitio Web en Desarrollo</h2>
          <p class="text-gray-600 mb-6">
              Los precios mostrados son de prueba y este sitio web estÃ¡ actualmente en desarrollo. Por favor, consulte con un agente antes de realizar cualquier pago o reserva.
          </p>
          <button id="development-popup-close" class="bg-guacamayafly-orange text-white font-semibold px-8 py-2 rounded-lg hover:bg-guacamayafly-dark-orange transition-colors">
              Entendido
          </button>
      </div>
  </div>

  <header class="bg-white border-b border-gray-200">
    <!-- New Mobile Header (lg:hidden) -->
    <div class="max-w-[1200px] mx-auto px-3 sm:px-6 lg:hidden">
        <div class="flex items-center justify-between h-16">
            <div class="flex items-center gap-2">
                <button id="hamburger-btn" class="text-gray-700">
                    <i class="fas fa-bars fa-lg"></i>
                </button>
                <a href="index.html">
                    <img alt="Logo Guacamayafly" height="32" src="https://guacamayafly.github.io/public/assets/img/logo-6.svg" width="32"/>
                </a>
            </div>
            <div class="flex-1 mx-4">
                <div class="relative">
                    <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
                    <input type="search" placeholder="Buscar" class="w-full pl-9 pr-3 py-2 border border-gray-300 rounded-full bg-gray-100 text-sm focus:bg-white focus:ring-1 focus:ring-guacamayafly-orange focus:border-guacamayafly-orange transition-colors">
                </div>
            </div>
            <div class="flex items-center">
                <div id="auth-status-container-mobile"></div>
            </div>
        </div>
    </div>

    <!-- Original Desktop Header (hidden lg:flex) -->
    <div class="hidden lg:flex max-w-[1200px] mx-auto px-3 py-3 sm:px-6 items-center justify-between relative">
      <div class="flex items-center gap-3">
        <a href="productdetails.html" class="text-guacamayafly-orange"><i class="fas fa-arrow-left fa-lg"></i></a>
        <div class="flex items-center space-x-2">
            <img alt="Logo Guacamayafly" height="32" src="https://guacamayafly.github.io/public/assets/img/logo-6.svg" width="32"/>
            <span class="font-extrabold text-lg select-none text-guacamayafly-orange">GUACAMAYAFLY</span>
        </div>
      </div>
      
      <nav class="flex items-center relative flex-1 justify-center w-auto mx-8">
        <div class="absolute w-full h-0.5 bg-gray-300 top-[12px] left-0 right-0"></div>
        <div id="progress-fill" class="absolute h-0.5 bg-guacamayafly-orange top-[12px] left-0 w-[16.5%] transition-all duration-300 ease-in-out"></div>

        <div id="step-1-header" class="flex flex-col items-center relative z-10 px-2">
          <div class="flex items-center justify-center w-6 h-6 rounded-full bg-guacamayafly-orange text-white text-xs font-semibold border-2 border-guacamayafly-orange">1</div>
          <span class="text-guacamayafly-orange font-semibold text-sm mt-1 whitespace-nowrap">InformaciÃ³n del cliente</span>
        </div>

        <div id="step-2-header" class="flex flex-col items-center relative z-10 px-2">
          <div class="flex items-center justify-center w-6 h-6 rounded-full border border-gray-300 bg-white text-xs text-gray-400">2</div>
          <span class="text-gray-600 text-sm mt-1 whitespace-nowrap">InformaciÃ³n de pago</span>
        </div>

        <div id="step-3-header" class="flex flex-col items-center relative z-10 px-2">
          <div class="flex items-center justify-center w-6 h-6 rounded-full border border-gray-300 bg-white text-xs text-gray-400"><i class="fas fa-check"></i></div>
          <span class="text-gray-600 text-sm mt-1 whitespace-nowrap">Â¡Reserva confirmada!</span>
        </div>
      </nav>
      
      <div class="flex items-center gap-4">
        <div id="auth-status-container-desktop">
        </div>
      </div>
    </div>
  </header>

  <!-- Se eliminÃ³ la clase 'heartbeat-animation' para quitar el pulso -->
  <div
    id="timer-bar"
    class="bg-[#fff0eb] border border-[#fcd9cc] text-[#b33a3a] text-sm font-semibold flex items-center justify-center space-x-2 py-2"
  >
    <i class="far fa-clock"></i>
    <span>Estamos manteniendo tu precio...</span>
    <span id="timer-display" class="font-mono tracking-wide">00:19:54</span>
  </div>

  <main
    id="main-content"
    class="max-w-[1200px] mx-auto px-6 py-8 flex flex-col lg:flex-row gap-6"
  >
    <aside class="w-full lg:w-[360px] flex flex-col order-first lg:order-last">
      <div
        id="date-display-block"
        class="bg-white border border-gray-300 rounded-xl p-4 mb-5 text-gray-600 cursor-pointer grid grid-cols-[1fr_auto_1fr_auto] items-center gap-x-2"
      >
        <div class="header-cell">Registrarse</div>
        <div></div>
        <div class="header-cell">Verificar</div>
        <div class="header-cell text-right"></div>

        <div class="flex flex-col items-start">
          <div id="display-checkin-date" class="font-semibold text-base text-[#222222]"></div>
          <div id="display-checkin-time" class="text-xs font-normal text-gray-600">14:00</div>
        </div>

        <div class="text-xl text-gray-600 flex-shrink-0">â†’</div>
        
        <div class="flex flex-col items-start">
          <div id="display-checkout-date" class="font-semibold text-base text-[#222222]"></div>
          <div id="display-checkout-time" class="text-xs font-normal text-gray-600">13:00</div>
        </div>
        
        <div class="flex flex-col items-end">
          <div id="display-nights" class="font-bold text-2xl text-[#222222]"></div>
          <div class="text-xs font-normal text-gray-600">nights</div>
        </div>
      </div>

      <div class="bg-white border border-gray-300 rounded-xl p-5 shadow-sm mb-6">
        <div class="flex gap-3 mb-4 pb-4 border-b border-gray-300">
          <img
            id="summary-hotel-image"
            alt="Foto del hotel"
            class="w-20 h-20 rounded-md object-cover flex-shrink-0"
            height="80"
            src="https://placehold.co/80x80/cccccc/ffffff?text=Hotel"
            width="80"
          />
          <div class="flex-1 text-sm">
            <h3 id="summary-hotel-name" class="font-semibold text-[#222222] mb-1">Cargando hotel...</h3>
            <div class="flex items-center text-gray-500 text-xs mb-1 space-x-1">
              <i class="fas fa-circle-notch fa-spin text-green-600 text-[10px]"></i>
              <span>Apartamento/Piso</span>
            </div>
            <div class="flex items-center mb-1 text-pink-600 space-x-1">
              <i class="fas fa-star text-sm"></i>
              <i class="fas fa-star text-sm"></i>
              <i class="fas fa-star text-sm"></i>
              <i class="fas fa-star text-sm"></i>
            </div>
            <div class="text-guacamayafly-green font-semibold text-sm mb-1">
              9.7 Excepcional
              <span class="text-gray-400 font-normal ml-1 text-xs">49 reseÃ±as</span>
            </div>
            <div id="summary-hotel-location" class="text-xs text-gray-500 mb-1 truncate max-w-[220px]">
              Cargando ubicaciÃ³n...
            </div>
            <a
              href="#"
              class="text-guacamayafly-orange text-xs font-semibold hover:underline mt-0.5 inline-block"
              >Â¿QuÃ© hay cerca?</a
            >
          </div>
        </div>

        <div class="bg-blue-50 rounded-md p-4 text-gray-700 text-sm space-y-2 border border-gray-300 mb-4">
          <div class="flex space-x-3 items-center font-semibold text-gray-900 pb-3">
            <img
              alt="Interior del apartamento"
              class="w-10 h-10 rounded-md object-cover flex-shrink-0"
              height="40"
              src="https://storage.googleapis.com/a1aa/image/a25bb66f-5ad8-4226-be1a-0afa0be991c9.jpg"
              width="40"
            />
            <div>
              1 x Apartamento
            </div>
          </div>
          <div class="py-1">Superficie: 50 mÂ²</div>
          <div id="summary-guests" class="py-1">MÃ¡x: 2 adultos</div>
          <div id="summary-bed-type" class="py-1 font-semibold">1 cama doble</div>
          <div class="flex items-center space-x-1 text-gray-500 text-xs py-1">
            <i class="fas fa-door-open"></i>
            <span>Ãšltimo check-in antes de las 20:30</span>
          </div>
          <div class="flex items-center space-x-1 text-gray-400 text-xs py-1">
            <i class="fas fa-check"></i>
            <span>Pagar en el hotel</span>
          </div>
          <div class="text-orange-600 text-xs font-semibold py-1 mt-2">
            <i class="fas fa-exclamation-triangle"></i>
            <span>Â¡Date prisa! Â¡Tenemos la Ãºltima habitaciÃ³n disponible para tus fechas a este precio!</span>
          </div>
        </div>

        <button
          type="button"
          class="w-full flex justify-between items-center text-sm font-semibold text-green-700 border border-gray-300 rounded px-4 py-2 hover:bg-green-50 transition"
        >
          <div class="flex items-center gap-3"><i class="fas fa-shield-alt text-lg"></i><span>PolÃ­tica de cancelaciÃ³n</span></div>
          <i class="fas fa-chevron-right text-lg"></i>
        </button>
      </div>

      <div class="bg-white rounded-xl border border-gray-200 text-sm mb-6">
        <div class="bg-red-500 text-white text-center py-1 rounded-t-xl text-xs font-semibold">
            21% DE DESCUENTO HOY
        </div>

        <div class="p-4">
          <div class="flex justify-between mb-1"><span class="font-medium">Precio original (<span id="price-nights-1"></span> noches)</span><span id="price-original" class="font-semibold"></span></div>
          <div class="flex justify-between mb-1"><span class="font-medium">Precio de la habitaciÃ³n (<span id="price-nights-2"></span> noches)</span><span id="price-room" class="font-semibold"></span></div>
          <div class="flex justify-between items-center border-t border-gray-200 pt-3 mt-3"><span class="font-semibold text-base">Precio final <i class="fas fa-info-circle text-xs ml-1"></i></span><span id="price-final" class="font-bold text-base"></span></div>
          <p class="text-[10px] text-gray-400 mb-3">
            Incluido en el precio total: Tasa de limpieza 17,07 â‚¬, IVA 52,56 â‚¬
          </p>
          <div class="border-t border-gray-200 pt-4 mt-4">
              <div class="flex justify-between mb-1"><span class="font-semibold text-base">Pagar en la Propiedad</span><span id="price-pay-at-property" class="font-bold text-base"></span></div>
              <p class="text-xs text-gray-500 mb-3">PagarÃ¡s en la moneda de la propiedad (los tipos de cambio pueden variar).</p>
          </div>
          <div class="bg-[#0b5e07] bg-opacity-10 rounded-xl p-3 text-xs text-[#0b5e07] font-semibold mt-4">Igualamos los precios. Â¡Si lo encuentras por menos, lo igualamos! <i class="fas fa-info-circle text-xs"></i></div>
        </div>
      </div>
      
      <div id="restored-info-boxes" class="space-y-6">
          <div class="bg-[#d9f0d9] rounded-xl p-4 text-sm text-[#0b5e07] flex items-center gap-2 font-semibold">
            <i class="fas fa-thumbs-up text-base"></i>
            <span>Â¡Excelente elecciÃ³n! <span class="font-normal">Has elegido nuestra tarifa mÃ¡s baja.</span></span>
          </div>
          <div class="bg-[#d9f0d9] rounded-xl p-4 text-sm text-[#0b5e07] flex items-center gap-2 font-semibold">
            <i class="fas fa-thumbs-up text-base"></i>
            <span>Gran variedad de propiedades, <span class="font-normal">con una calificaciÃ³n promedio de 9,7</span></span>
          </div>
          <div class="bg-[#fddede] rounded-xl p-4 text-sm text-[#b33a3a] flex items-center gap-2 font-semibold">
            <i class="fas fa-clock text-base"></i> Â¡Date prisa! Â¡Tenemos la Ãºltima habitaciÃ³n disponible para tus fechas a este precio!
          </div>
          <div class="bg-[#ffe3d3] rounded-xl p-4 text-sm text-[#b35a0b] flex items-center gap-2 font-semibold">
            <i class="fas fa-clock text-base"></i>
            <span>Faltan solo <span id="days-left" class="font-bold">2</span> dÃ­as para tu llegada. <span class="font-bold">Las tarifas podrÃ­an aumentar si no reservas ahora.</span></span>
          </div>
          <div class="bg-white rounded-xl border border-gray-200 p-4 text-sm">
            <h3 class="font-semibold text-base mb-2">Sobre el pago</h3>
            <p class="text-xs text-gray-500">
              El pago de esta reserva serÃ¡ cobrado por la propiedad, no por Guacamayafly. Compartiremos los detalles de tu tarjeta de crÃ©dito con nuestro proveedor y con la propiedad para asegurar tu reserva y completar la transacciÃ³n.
              <a href="#" class="text-guacamayafly-orange font-semibold hover:underline">Ver condiciones de reserva.</a>
            </p>
          </div>
      </div>

    </aside>

    <section class="flex-1 bg-white rounded-xl border border-gray-200 p-6 max-w-full">
      <div class="bg-orange-100 border border-orange-200 text-orange-800 text-sm p-4 rounded-xl mb-6">
          <p class="font-semibold mb-2">
              Â¡Inicia sesiÃ³n para utilizar tu Guacamayafly Cash!
              <a href="#" class="text-guacamayafly-dark-orange hover:underline font-bold">Iniciar sesiÃ³n</a>
          </p>
          <p class="text-xs text-orange-700">Iniciar sesiÃ³n en su cuenta de Guacamayafly le permitirÃ¡ realizar reservas mÃ¡s rÃ¡pidas y obtener mÃ¡s recompensas.</p>
      </div>

      <!-- Container for both steps to manage visibility -->
      <div>
          <!-- Step 2: Payment Information -->
          <div id="step-2-payment-info" style="display: none;">
              <h2 class="text-base font-semibold mb-2">InformaciÃ³n de pago</h2>
              <p class="text-sm text-gray-600 mb-4">Por favor, selecciona tu mÃ©todo de pago preferido.</p>
              
              <div class="mt-6">
                  <label class="block text-sm font-medium text-gray-700 mb-2">MÃ©todo de Pago</label>
                  <div class="space-y-3" id="payment-options-container">
                      <div class="payment-option" data-payment="whatsapp"><div class="flex items-center justify-between"><span class="font-semibold text-sm">Reservar por WhatsApp</span><i class="fab fa-whatsapp text-xl text-green-500"></i></div></div>
                      <div class="payment-option" data-payment="card"><div class="flex items-center justify-between"><span class="font-semibold text-sm">Tarjeta de CrÃ©dito/DÃ©bito</span><div class="flex items-center gap-2"><img src="https://cryptoindex.com/pic/icons/visa-mastercard.svg" alt="Visa y Mastercard" class="payment-logo"></div></div></div>
                      <div class="payment-option" data-payment="crypto"><div class="flex items-center justify-between"><span class="font-semibold text-sm">Pagar con Criptomonedas</span><img src="https://www.bybit.com/bycsi-root/assets/image/coins/light/btc.svg?quality=63&format=avif&resize=width/50.4" alt="Bitcoin" class="payment-logo"></div></div>
                  </div>
              </div>

              <div class="flex justify-between mt-6">
                  <button
                      type="button"
                      id="prev-step-btn"
                      class="bg-white text-gray-700 text-lg font-bold py-3 px-6 rounded-full border border-gray-300 hover:bg-gray-100 transition"
                  >
                      ANTERIOR
                  </button>
              </div>
          </div>

          <!-- Step 1: All other content now wrapped in a single div -->
          <div id="step-1-content">
            <h2 class="text-base font-semibold mb-2">Â¿QuiÃ©n es el invitado principal?</h2>
            <p class="text-sm text-[#b33a3a] mb-4 font-semibold">*Campo obligatorio</p>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
              <div>
                <label class="block text-sm font-semibold text-gray-600 mb-1" for="nombre">Nombre de pila *</label>
                <input class="w-full border border-gray-300 rounded-xl px-4 py-3 text-base focus:outline-none focus:ring-1 focus:ring-guacamayafly-orange" id="nombre" name="nombre" type="text" required />
              </div>
              <div>
                <label class="block text-sm font-semibold text-gray-600 mb-1" for="apellido">Apellido *</label>
                <input class="w-full border border-gray-300 rounded-xl px-4 py-3 text-base focus:outline-none focus:ring-1 focus:ring-guacamayafly-orange" id="apellido" name="apellido" type="text" required />
              </div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
              <div>
                <label class="block text-sm font-semibold text-gray-600 mb-1" for="email">Correo electrÃ³nico *</label>
                <input class="w-full border border-gray-300 rounded-xl px-4 py-3 text-base focus:outline-none focus:ring-1 focus:ring-guacamayafly-orange" id="email" name="email" type="email" required />
              </div>
              <div>
                <label class="block text-sm font-semibold text-gray-600 mb-1" for="pais">PaÃ­s/regiÃ³n de residencia *</label>
                <select class="w-full border border-gray-300 rounded-xl px-4 py-3 text-base focus:outline-none focus:ring-1 focus:ring-guacamayafly-orange" id="pais" name="pais" required>
                  <option value="">Selecciona un paÃ­s</option>
                  <option>PaÃ­ses Bajos</option><option>EspaÃ±a</option><option>Venezuela</option><option>Colombia</option>
                </select>
              </div>
            </div>
            <div class="mb-6">
              <label class="block text-sm font-semibold text-gray-600 mb-1" for="telefono">NÃºmero de telÃ©fono (opcional)</label>
              <input class="w-full border border-gray-300 rounded-xl px-4 py-3 text-base focus:outline-none focus:ring-1 focus:ring-guacamayafly-orange" id="telefono" name="telefono" type="tel" />
            </div>

            <fieldset class="border border-gray-300 rounded-xl p-4 mb-6 text-sm" aria-label="Solicitudes especiales">
              <legend class="font-semibold text-base mb-2">Solicitudes especiales</legend>
              <p class="text-gray-500 mb-4 text-sm">Selecciona tu(s) preferencia(s) (sujeto a disponibilidad).</p>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                  <p class="font-semibold mb-2 text-sm">Â¿QuÃ© tipo de habitaciÃ³n preferirÃ­as?</p>
                  <div class="flex items-center mb-2">
                    <input class="mr-2 w-5 h-5 accent-guacamayafly-orange" id="no-fumadores" name="fumadores" type="radio" />
                    <label class="flex items-center gap-1 text-sm" for="no-fumadores"><i class="fas fa-smoking-ban text-lg"></i> HabitaciÃ³n de no fumadores</label>
                  </div>
                  <div class="flex items-center">
                    <input class="mr-2 w-5 h-5 accent-guacamayafly-orange" id="fumadores" name="fumadores" type="radio" />
                    <label class="flex items-center gap-1 text-sm" for="fumadores"><i class="fas fa-smoking text-lg"></i> HabitaciÃ³n de fumadores</label>
                  </div>
                </div>
                <div>
                  <p class="font-semibold mb-2 text-sm">Â¿QuÃ© configuraciÃ³n de camas prefieres?</p>
                  <div class="flex items-center mb-2">
                    <input class="mr-2 w-5 h-5 accent-guacamayafly-orange" id="cama-grande" name="camas" type="radio" />
                    <label class="flex items-center gap-1 text-sm" for="cama-grande"><i class="fas fa-bed text-lg"></i> Quiero una cama grande</label>
                  </div>
                  <div class="flex items-center">
                    <input class="mr-2 w-5 h-5 accent-guacamayafly-orange" id="camas-separadas" name="camas" type="radio" />
                    <label class="flex items-center gap-1 text-sm" for="camas-separadas"><i class="fas fa-bed text-lg"></i> Quiero camas separadas</label>
                  </div>
                </div>
              </div>
              <button type="button" class="mt-3 text-sm text-guacamayafly-orange font-semibold hover:underline flex items-center gap-1">Haz clic aquÃ­ para mÃ¡s solicitudes.<i class="fas fa-chevron-down text-sm"></i></button>
            </fieldset>
            
            <div id="hospitality-info" class="bg-white rounded-xl border border-gray-200 p-6 my-6">
              <h2 class="text-base font-semibold mb-2">InformaciÃ³n adicional sobre hospitalidad</h2>
              <p class="text-gray-500 mb-4 text-sm">Por favor proporcione la siguiente informaciÃ³n para optimizar los servicios que brinda la propiedad</p>
              <p class="font-semibold mb-2 text-sm">AvÃ­sanos cuando llegues</p>
              <p class="text-gray-500 mb-4 text-sm">Le informaremos a la propiedad o al anfitriÃ³n cuÃ¡ndo esperarlo.</p>
              <select class="w-full border border-gray-300 rounded-xl px-4 py-3 text-base focus:outline-none focus:ring-1 focus:ring-guacamayafly-orange">
                  <option>Seleccionar</option><option>No sÃ©</option>
              </select>
            </div>

            <div id="info-boxes-container-form">
                <div class="bg-white rounded-xl border border-gray-200 p-6 my-6">
                  <div class="flex items-center mb-4">
                      <input type="checkbox" id="guacamayafly-updates" class="w-5 h-5 text-guacamayafly-orange rounded focus:ring-guacamayafly-orange">
                      <label for="guacamayafly-updates" class="ml-2 text-sm text-gray-700">
                          Acepto recibir actualizaciones y promociones de Guacamayafly y sus afiliados o socios comerciales a travÃ©s de diversos canales, incluido WhatsApp. Puede cancelar su suscripciÃ³n en cualquier momento.
                          <a href="#" class="text-guacamayafly-orange hover:underline">Lea mÃ¡s en la PolÃ­tica de Privacidad.</a>
                      </label>
                  </div>
                  <div class="bg-green-100 border border-green-200 text-green-800 text-sm p-4 rounded-xl flex items-center gap-2 font-semibold">
                      <i class="fas fa-check-circle text-base"></i>
                      <span>Â¡No necesitas tarjeta de crÃ©dito para reservar! <span class="font-normal">Puedes reservar ahora sin proporcionar detalles de pago y pagar en el establecimiento durante tu estancia.</span></span>
                  </div>
                </div>

                <div id="terms-section" class="bg-white rounded-xl border border-gray-200 p-6 my-6">
                  <p class="text-sm text-gray-600 mb-3">
                      Al continuar con esta reserva, acepto los tÃ©rminos y condiciones de Guacamayafly. 
                      <a href="#" class="text-guacamayafly-orange font-semibold hover:underline">Condiciones de uso</a> y
                      <a href="#" class="text-guacamayafly-orange font-semibold hover:underline">polÃ­tica de privacidad</a>.
                  </p>
                </div>
            </div>

          </div>
      </div>
    </section>
  </main>
  <div id="footer-sentinel"></div>


<section id="crypto-checkout-section" class="hidden max-w-4xl mx-auto py-12 px-6">
    <div class="flex justify-between items-center mb-6">
        <h2 class="text-3xl font-bold text-gray-800">Finalizar Pago con Criptomonedas</h2>
        <button id="close-crypto-checkout-btn" class="text-gray-500 hover:text-gray-800"><i class="fas fa-times fa-lg"></i>&nbsp;Volver</button>
    </div>
    <div class="bg-gray-50 p-6 rounded-lg shadow-md">
        <div class="flex flex-col md:flex-row gap-8">
            <div class="md:w-2/3">
                <h3 class="font-bold text-gray-700 mb-3 text-lg">Resumen de la Reserva</h3>
                <div id="crypto-summary-details" class="text-sm space-y-2 text-gray-600">
                </div>
            </div>
            <div class="md:w-1/2 flex flex-col items-center">
                <p class="font-semibold text-gray-700 mb-2">Escanear para Pagar</p>
                <div class="p-3 border rounded-lg bg-white shadow-sm">
                    <img src="https://api.qrserver.com/v1/create-qr-code/?size=180x180&data=bc1qxy2kgdygjrsqtzq2n0yrf2493p83kkfjhx0wlh" alt="CÃ³digo QR de pago" id="crypto-qr-code-img" class="w-40 h-40">
                </div>
                 <p class="text-xs text-gray-500 mt-2">Use su billetera para escanear</p>
            </div>
        </div>
        <div class="mt-6 border-t pt-6">
            <h3 class="font-bold text-gray-700 mb-3 text-lg">O Pagar a la Siguiente DirecciÃ³n</h3>
            <div id="crypto-wallets-list" class="space-y-3"></div>
            <div class="mt-4">
              <label class="block text-sm font-semibold text-gray-600 mb-1" for="comprobante-pago">Cargar Comprobante de Pago (opcional)</label>
              <input type="file" id="comprobante-pago" class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100"/>
            </div>
            <button id="payment-received-btn" class="w-full bg-guacamayafly-orange text-white text-lg font-bold py-3 rounded-full hover:bg-guacamayafly-dark-orange transition mt-6">He pagado</button>
            <p id="payment-validation-message" class="text-center text-sm text-gray-600 mt-2 hidden">Validando pago... <span id="countdown-timer"></span></p>
        </div>
    </div>
</section>

<section id="reservation-confirmed-section" class="hidden max-w-2xl mx-auto py-12 px-6 text-center bg-white rounded-xl shadow-lg mt-8">
    <div class="text-green-500 mb-4"><i class="fas fa-check-circle fa-5x"></i></div>
    <h2 class="text-3xl font-bold text-gray-800 mb-2">Â¡Reserva Confirmada!</h2>
    <p class="text-lg text-gray-600 mb-4">Tu reserva ha sido procesada con Ã©xito.</p>
    <p class="text-xl font-bold text-guacamayafly-orange mb-2">NÃºmero de Reserva: <span id="booking-number"></span></p>
    <p class="text-base text-gray-700 mb-4">ID de ConfirmaciÃ³n: <span id="confirmation-id"></span></p>
    <p class="text-sm text-gray-500">RecibirÃ¡s un correo electrÃ³nico de confirmaciÃ³n con todos los detalles de tu reserva en breve.</p>
    <p class="text-sm text-gray-500 mt-4">Redirigiendo al inicio en <span id="redirect-countdown" class="font-bold">6</span> segundos...</p>
    <button onclick="window.location.href = 'index.html';" class="mt-6 bg-guacamayafly-orange text-white text-lg font-bold py-3 px-6 rounded-full hover:bg-guacamayafly-dark-orange transition">
        Volver al Inicio
    </button>
</section>

<div id="calendar-modal" class="modal-overlay hidden calendar-modal">
    <div class="modal-container">
        <div class="calendar-modal-header">
             <h3 class="font-semibold text-lg">Selecciona fechas</h3>
             <button id="close-calendar-modal-x" class="p-2 rounded-full hover:bg-gray-200 text-2xl leading-none">&times;</button>
        </div>
        <div class="calendar-modal-top-info">
            <div class="info-box"><span class="label">Check-in</span><span id="calendar-checkin-display" class="value">--</span></div>
            <div class="info-box"><span class="label">Check-out</span><span id="calendar-checkout-display" class="value">--</span></div>
        </div>
        <div class="calendar-modal-body">
            <div class="flex items-center gap-2 text-sm text-gray-700 mb-4"><i class="far fa-calendar-alt"></i><p>Selecciona fechas para encontrar los mejores precios para tu viaje</p></div>
            <div class="calendar-header">
                <button id="prev-month" class="p-2 rounded-full hover:bg-gray-200"><i class="fas fa-chevron-left"></i></button>
                <h4 id="calendar-month-year" class="font-semibold text-lg"></h4>
                <button id="next-month" class="p-2 rounded-full hover:bg-gray-200"><i class="fas fa-chevron-right"></i></button>
            </div>
            <div class="calendar-months" id="calendar-months-container"></div>
            <div class="price-legend">
                <div><div class="color-box" style="background-color: #d1fae5;"></div><span>MÃ¡s barato</span></div>
                <div><div class="color-box" style="background-color: #fee2e2;"></div><span>MÃ¡s caro</span></div>
            </div>
            <p class="text-center text-xs text-gray-500 mt-2">SegÃºn los precios promedio</p>
             <div class="quick-select-buttons">
                <button id="tonight-btn">Esta noche</button>
                <button id="next-weekend-btn">El prÃ³ximo fin de semana</button>
            </div>
        </div>
        <div class="calendar-modal-footer">
            <button id="clear-dates-btn" class="bg-gray-200 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-300 font-semibold">Limpiar</button>
            <button id="close-calendar-btn" class="bg-guacamayafly-orange text-white px-6 py-2 rounded-lg hover:bg-guacamayafly-dark-orange font-semibold">Aplicar</button>
        </div>
    </div>
</div>

<footer id="page-footer" class="bg-gray-100 mt-12 py-10 text-xs text-blue-900">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="max-w-5xl mx-auto grid grid-cols-1 sm:grid-cols-4 gap-y-6 gap-x-8">
            <div>
                <div class="mb-3 font-semibold">Empresa</div>
                <ul class="space-y-1">
                    <li><a class="hover:underline" href="https://wa.me/5804243156057">QuiÃ©nes somos</a></li>
                    <li><a class="hover:underline" href="https://wa.me/5804243156057">Empleo</a></li>
                    <li><a class="hover:underline" href="https://wa.me/5804243156057">Anuncia tu alojamiento</a></li>
                    <li><a class="hover:underline" href="https://wa.me/5804243156057">Publicidad</a></li>
                    <li><a class="hover:underline" href="https://wa.me/5804243156057">Prensa</a></li>
                </ul>
            </div>
            <div>
                <div class="mb-3 font-semibold">BÃºsquedas</div>
                <ul class="space-y-1">
                    <li><a class="hover:underline" href="https://wa.me/5804243156057">Viajes a EspaÃ±a</a></li>
                    <li><a class="hover:underline" href="https://wa.me/5804243156057">Hoteles en EspaÃ±a</a></li>
                    <li><a class="hover:underline" href="https://wa.me/5804243156057">Alquileres vacacionales EspaÃ±a</a></li>
                    <li><a class="hover:underline" href="https://wa.me/5804243156057">Paquetes de vacaciones baratos</a></li>
                    <li><a class="hover:underline" href="https://wa.me/5804243156057">Vuelos baratos en EspaÃ±a</a></li>
                    <li><a class="hover:underline" href="https://wa.me/5804243156057">Alquiler de coches en EspaÃ±a</a></li>
                    <li><a class="hover:underline" href="https://wa.me/5804243156057">Todos los alojamientos</a></li>
                    <li><a class="hover:underline" href="https://wa.me/5804243156057">Guacamayafly Explore</a></li>
                </ul>
            </div>
            <div>
                <div class="mb-3 font-semibold">PolÃ­ticas</div>
                <ul class="space-y-1">
                    <li><a class="hover:underline" href="https://wa.me/5804243156057">TÃ©rminos y condiciones generales (excepto para reservas de Vrbo)</a></li>
                    <li><a class="hover:underline" href="https://wa.me/5804243156057">TÃ©rminos y condiciones de Vrbo</a></li>
                    <li><a class="hover:underline" href="https://wa.me/5804243156057">Privacidad</a></li>
                    <li><a class="hover:underline" href="https://wa.me/5804243156057">Cookies</a></li>
                    <li><a class="hover:underline" href="https://wa.me/5804243156057">Condiciones de uso</a></li>
                    <li><a class="hover:underline" href="https://wa.me/5804243156057">InformaciÃ³n legal/contacto</a></li>
                    <li><a class="hover:underline" href="https://wa.me/5804243156057">Pautas sobre el contenido y cÃ³mo denunciar contenido</a></li>
                </ul>
            </div>
            <div>
                <div class="mb-3 font-semibold">Ayuda</div>
                <ul class="space-y-1">
                    <li><a class="hover:underline" href="https://wa.me/5804243156057">Ayuda</a></li>
                    <li><a class="hover:underline" href="https://wa.me/5804243156057">Cancelar un vuelo</a></li>
                    <li><a class="hover:underline" href="https://wa.me/5804243156057">Cancelar una reserva de hotel o de un alquiler vacacional</a></li>
                    <li><a class="hover:underline" href="https://wa.me/5804243156057">Plazos de reembolso</a></li>
                    <li><a class="hover:underline" href="https://wa.me/5804243156057">Utilizar un cupÃ³n de Guacamayafly</a></li>
                    <li><a class="hover:underline" href="https://wa.me/5804243156057">Documentos para viajes internacionales</a></li>
                </ul>
            </div>
        </div>
        <div class="mt-8 text-center text-[9px] text-gray-600">
            El sitio web de Guacamayafly.es permite pagar con American Express, Diner's Club International, MasterCard, Visa, Visa Electron, CartSsi, Carte Bleue y PayPal.
        </div>
    </div>
</footer>

<button aria-label="Ayuda" class="fixed bottom-4 right-4 bg-white border border-gray-300 rounded-full px-3 py-1 text-xs text-gray-700 shadow-md hover:bg-gray-50 flex items-center space-x-1" onclick="window.location.href='https://wa.me/5804243156057'">
    <span>Ayuda</span><i class="fas fa-question-circle"></i>
</button>

<div id="sticky-reserve-btn-container">
    <button id="sticky-reserve-btn"><i class="fas fa-lock"></i><span>Â¡RESERVA YA!</span></button>
    <p id="sticky-reserve-info">No se necesita tarjeta de crÃ©dito ni pago para reservar.</p>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // --- START OF DYNAMIC DATA LOGIC ---

        // Global variable to hold booking details
        let bookingDetails = {};
        let selectedDeparture, selectedReturn;

        // Function to parse URL parameters
        function getBookingDetailsFromSession() {
            const detailsString = sessionStorage.getItem('hotelBookingDetails');
            if (detailsString) {
                try {
                    return JSON.parse(detailsString);
                } catch (e) {
                    console.error("Error parsing booking details from sessionStorage:", e);
                    return null;
                }
            }
            // Fallback for testing if sessionStorage is empty
            return {
                hotelId: 1,
                hotelName: 'Hotel de Prueba',
                hotelImage: 'https://placehold.co/80x80/FF7F00/FFFFFF?text=Hotel',
                hotelLocation: 'UbicaciÃ³n de Prueba',
                price: 150, // Default price per night
                checkin: new Date().toISOString().split('T')[0],
                checkout: new Date(new Date().setDate(new Date().getDate() + 2)).toISOString().split('T')[0],
                adults: 2,
                children: 0
            };
        }

        // Function to update all dynamic elements on the page
        function populatePage(details) {
            if (!details) {
                console.error("No booking details found to populate page.");
                document.getElementById('main-content').innerHTML = '<p class="text-center text-red-500">Error: No se pudieron cargar los detalles de la reserva. Por favor, vuelve a la pÃ¡gina anterior e intÃ©ntalo de nuevo.</p>';
                return;
            }

            bookingDetails = details;
            
            selectedDeparture = new Date(details.checkin + 'T00:00:00');
            selectedReturn = new Date(details.checkout + 'T00:00:00');
            updateDateDisplayInSummary();

            document.getElementById('summary-hotel-image').src = details.hotelImage || 'https://placehold.co/80x80/cccccc/ffffff?text=Hotel';
            document.getElementById('summary-hotel-name').textContent = details.hotelName || 'Nombre no disponible';
            document.getElementById('summary-hotel-location').textContent = details.hotelLocation || 'UbicaciÃ³n no disponible';
            document.getElementById('summary-guests').textContent = `MÃ¡x: ${details.adults} adulto(s), ${details.children > 0 ? `${details.children} niÃ±o(s)` : ''}`;
            
            updatePriceSummary();

            const cryptoSummaryContainer = document.getElementById('crypto-summary-details');
            if (cryptoSummaryContainer) {
                updateCryptoSummary();
            }
        }
        
        function calculateNights(start, end) {
            if (!start || !end || end <= start) return 0;
            const diffTime = Math.abs(end - start);
            return Math.ceil(diffTime / (1000 * 60 * 60 * 24));
        }

        function calculateTotalPrice(start, end, pricePerNight) {
            const nights = calculateNights(start, end);
            const roomPrice = nights * (pricePerNight || 0);
            const originalPrice = roomPrice / (1 - 0.21); // Assuming 21% discount
            const finalPrice = roomPrice + 17.07 + 52.56; // Adding fixed fees
            return {
                original: originalPrice,
                room: roomPrice,
                final: finalPrice,
                nights: nights
            };
        }

        function updatePriceSummary() {
            const prices = calculateTotalPrice(selectedDeparture, selectedReturn, bookingDetails.price);
            document.getElementById('price-nights-1').textContent = prices.nights;
            document.getElementById('price-nights-2').textContent = prices.nights;
            document.getElementById('price-original').textContent = `${prices.original.toFixed(2)} â‚¬`;
            document.getElementById('price-room').textContent = `${prices.room.toFixed(2)} â‚¬`;
            document.getElementById('price-final').textContent = `${prices.final.toFixed(2)} â‚¬`;
            document.getElementById('price-pay-at-property').textContent = `${prices.final.toFixed(2)} â‚¬`;
            updateCryptoSummary();
        }

        function updateCryptoSummary() {
            const cryptoSummaryContainer = document.getElementById('crypto-summary-details');
            if (cryptoSummaryContainer) {
                 const prices = calculateTotalPrice(selectedDeparture, selectedReturn, bookingDetails.price);
                 cryptoSummaryContainer.innerHTML = `
                    <p><strong>Hotel:</strong> ${bookingDetails.hotelName}</p>
                    <p><strong>Check-in:</strong> ${selectedDeparture.toLocaleDateString('es-ES', { weekday: 'short', day: 'numeric', month: 'long' })}</p>
                    <p><strong>Check-out:</strong> ${selectedReturn.toLocaleDateString('es-ES', { weekday: 'short', day: 'numeric', month: 'long' })}</p>
                    <p><strong>Noches:</strong> ${prices.nights}</p>
                    <p class="font-bold mt-2 text-lg text-guacamayafly-orange">Monto a Pagar: ${prices.final.toFixed(2)} â‚¬</p>
                `;
            }
        }

        // --- END OF DYNAMIC DATA LOGIC ---


        const devPopupOverlay = document.getElementById('development-popup-overlay');
        const devPopupCloseBtn = document.getElementById('development-popup-close');
        let onPopupConfirmCallback = null;

        function showDevelopmentPopup(callback) {
            onPopupConfirmCallback = callback;
            if (devPopupOverlay) {
                devPopupOverlay.classList.remove('hidden');
                setTimeout(() => devPopupOverlay.classList.add('visible'), 10);
            }
        }

        if (devPopupCloseBtn) {
            devPopupCloseBtn.addEventListener('click', () => {
                if (devPopupOverlay) {
                    devPopupOverlay.classList.remove('visible');
                    devPopupOverlay.addEventListener('transitionend', () => {
                        devPopupOverlay.classList.add('hidden');
                    }, { once: true });
                }
                if (typeof onPopupConfirmCallback === 'function') {
                    onPopupConfirmCallback();
                    onPopupConfirmCallback = null;
                }
            });
        }
        
        if (!sessionStorage.getItem('checkoutPopupShown')) {
            showDevelopmentPopup(() => {
                sessionStorage.setItem('checkoutPopupShown', 'true');
            });
        }

        const form = document.querySelector('section.flex-1');
        const mainContent = document.getElementById('main-content');
        const step1 = document.getElementById('step-1-content');
        const step2 = document.getElementById('step-2-payment-info');
        const prevStepBtn = document.getElementById('prev-step-btn');
        const progressFill = document.getElementById('progress-fill');
        const step1Header = document.getElementById('step-1-header');
        const step2Header = document.getElementById('step-2-header');
        const step3Header = document.getElementById('step-3-header');

        const cryptoCheckoutSection = document.getElementById('crypto-checkout-section');
        const closeCryptoCheckoutBtn = document.getElementById('close-crypto-checkout-btn');
        const paymentReceivedBtn = document.getElementById('payment-received-btn');
        const paymentValidationMessage = document.getElementById('payment-validation-message');
        const countdownTimerDisplay = document.getElementById('countdown-timer');
        const reservationConfirmedSection = document.getElementById('reservation-confirmed-section');
        const bookingNumberElement = document.getElementById('booking-number');
        const confirmationIdElement = document.getElementById('confirmation-id');
        const redirectCountdownElement = document.getElementById('redirect-countdown');

        const stickyReserveBtnContainer = document.getElementById('sticky-reserve-btn-container');
        const stickyReserveBtn = document.getElementById('sticky-reserve-btn');

        const dateDisplayBlock = document.getElementById('date-display-block');
        const calendarModal = document.getElementById('calendar-modal');
        const calendarMonthsContainer = document.getElementById('calendar-months-container');
        const prevMonthBtn = document.getElementById('prev-month');
        const nextMonthBtn = document.getElementById('next-month');
        const closeCalendarBtn = document.getElementById('close-calendar-btn');
        const clearDatesBtn = document.getElementById('clear-dates-btn');
        const closeCalendarModalX = document.getElementById('close-calendar-modal-x');
        const calendarCheckinDisplay = document.getElementById('calendar-checkin-display');
        const calendarCheckoutDisplay = document.getElementById('calendar-checkout-display');
        const calendarMonthYear = document.getElementById('calendar-month-year');
        const tonightBtn = document.getElementById('tonight-btn');
        const nextWeekendBtn = document.getElementById('next-weekend-btn');

        let timerInterval;
        const initialTimeInSeconds = 20 * 60;
        let timeLeft = initialTimeInSeconds;
        
        let currentStep = 1;
        let currentMonthDate = new Date();

        function showNotification(message, type = 'success') {
            let container = document.getElementById('notification-container');
            if (!container) {
                const body = document.querySelector('body');
                const newContainer = document.createElement('div');
                newContainer.id = 'notification-container';
                body.appendChild(newContainer);
                container = newContainer;
            }
            const popup = document.createElement('div');
            popup.className = `notification-popup ${type === 'error' ? 'bg-red-500' : 'bg-green-500'}`;
            popup.textContent = message;
            container.appendChild(popup);
            requestAnimationFrame(() => popup.classList.add('show'));
            setTimeout(() => {
                popup.classList.remove('show');
                popup.addEventListener('transitionend', () => popup.remove());
            }, 3000);
        }

        function formatTime(seconds) {
            const minutes = Math.floor(seconds / 60);
            const remainingSeconds = seconds % 60;
            return `${String(minutes).padStart(2, '0')}:${String(remainingSeconds).padStart(2, '0')}`;
        }

        function startTimer() {
            if (timerInterval) clearInterval(timerInterval);
            const timerDisplay = document.getElementById('timer-display');
            if (!timerDisplay) return;
            timerInterval = setInterval(() => {
                if (timeLeft > 0) {
                    timeLeft--;
                    timerDisplay.textContent = formatTime(timeLeft);
                } else {
                    clearInterval(timerInterval);
                    timerDisplay.textContent = '00:00';
                    showNotification('Â¡Tu precio ha caducado! Por favor, actualiza la pÃ¡gina.', 'error');
                }
            }, 1000);
        }
        
        function renderAuthStatus() {
            const authStatusContainerDesktop = document.getElementById('auth-status-container-desktop');
            const authStatusContainerMobile = document.getElementById('auth-status-container-mobile');
            const isLoggedIn = localStorage.getItem('isLoggedIn') === 'true';

            // Desktop HTML
            const loggedInHTMLDesktop = `
                <div class="flex items-center space-x-2">
                    <img src="https://placehold.co/32x32/FF7F00/FFFFFF?text=AV" alt="User Avatar" class="rounded-full w-8 h-8 cursor-pointer" id="avatar-btn">
                    <button id="logout-btn" class="text-blue-600 border border-blue-600 rounded-full px-3 py-1 text-xs sm:text-sm font-semibold hover:bg-blue-600 hover:text-white transition">
                        Cerrar sesiÃ³n
                    </button>
                </div>
            `;
            const loggedOutHTMLDesktop = `
                <button id="login-btn-desktop" class="bg-blue-600 text-white rounded-full px-4 py-1.5 text-sm font-semibold hover:bg-blue-700 transition">
                    Iniciar sesiÃ³n
                </button>
            `;

            // Mobile HTML
            const loggedInHTMLMobile = `
                <img src="https://placehold.co/32x32/FF7F00/FFFFFF?text=AV" alt="User Avatar" class="rounded-full w-8 h-8 cursor-pointer" id="avatar-btn-mobile">
            `;
            const loggedOutHTMLMobile = `
                <button id="login-btn-mobile" class="bg-blue-600 rounded-full h-8 w-8 flex items-center justify-center">
                    <i class="fas fa-user text-white"></i>
                </button>
            `;

            if(authStatusContainerDesktop) {
                authStatusContainerDesktop.innerHTML = isLoggedIn ? loggedInHTMLDesktop : loggedOutHTMLDesktop;
            }
            if(authStatusContainerMobile) {
                authStatusContainerMobile.innerHTML = isLoggedIn ? loggedInHTMLMobile : loggedOutHTMLMobile;
            }
        }
        
        // Event listener for all auth buttons
        document.body.addEventListener('click', (event) => {
            const target = event.target.closest('button');
            if (!target) return;

            const targetId = target.id;
            if (targetId === 'login-btn-desktop' || targetId === 'login-btn-mobile') {
                localStorage.setItem('isLoggedIn', 'true');
                location.reload();
            } else if (targetId === 'logout-btn') {
                localStorage.setItem('isLoggedIn', 'false');
                location.reload();
            }
        });
        
        function updateStepVisibility() {
            mainContent.classList.remove('hidden');
            cryptoCheckoutSection.classList.add('hidden');
            reservationConfirmedSection.classList.add('hidden');
            if (form) form.classList.remove('hidden');
            stickyReserveBtnContainer.classList.remove('hidden');

            if (currentStep === 1) {
                if (step1) step1.style.display = 'block';
                if (step2) step2.style.display = 'none';
                stickyReserveBtn.innerHTML = '<i class="fas fa-lock"></i><span>Â¡RESERVA YA!</span>';
                document.getElementById('sticky-reserve-info').textContent = 'No se necesita tarjeta de crÃ©dito ni pago para reservar.';
                if(progressFill) progressFill.style.width = '16.5%';
                updateHeaderSteps(1);
            } else if (currentStep === 2) {
                if (step1) step1.style.display = 'none';
                if (step2) step2.style.display = 'block';
                stickyReserveBtn.innerHTML = '<i class="fas fa-lock"></i><span>PAGAR AHORA</span>';
                document.getElementById('sticky-reserve-info').textContent = 'No se necesita tarjeta de crÃ©dito ni pago para reservar.';
                if(progressFill) progressFill.style.width = '50%';
                updateHeaderSteps(2);
            } else if (currentStep === 3) {
                mainContent.classList.add('hidden');
                if (form) form.classList.add('hidden');
                cryptoCheckoutSection.classList.add('hidden');
                reservationConfirmedSection.classList.remove('hidden');
                if(progressFill) progressFill.style.width = '100%';
                updateHeaderSteps(3);
                generateAndDisplayBookingInfo();
                startRedirectCountdown();
                stickyReserveBtnContainer.classList.add('hidden');
            }
        }

        function updateHeaderSteps(activeStep) {
            const headers = [step1Header, step2Header, step3Header];
            headers.forEach((header, index) => {
                if (!header) return;
                const circle = header.querySelector('div');
                const text = header.querySelector('span');
                const stepNum = index + 1;

                if (stepNum === activeStep) {
                    circle.classList.add('bg-guacamayafly-orange', 'text-white', 'border-guacamayafly-orange');
                    circle.classList.remove('bg-white', 'text-gray-400', 'border-gray-300');
                    text.classList.add('text-guacamayafly-orange', 'font-semibold');
                    text.classList.remove('text-gray-600');
                } else {
                    circle.classList.remove('bg-guacamayafly-orange', 'text-white', 'border-guacamayafly-orange');
                    circle.classList.add('bg-white', 'text-gray-400', 'border-gray-300');
                    text.classList.remove('text-guacamayafly-orange', 'font-semibold');
                    text.classList.add('text-gray-600');
                }
            });

            if (activeStep >= 3 && step3Header) {
                const circle = step3Header.querySelector('div');
                circle.innerHTML = '<i class="fas fa-check"></i>';
                circle.classList.add('bg-guacamayafly-orange', 'text-white', 'border-guacamayafly-orange');
                circle.classList.remove('bg-white', 'text-gray-400', 'border-gray-300');
                step3Header.querySelector('span').classList.add('text-guacamayafly-orange', 'font-semibold');
                step3Header.querySelector('span').classList.remove('text-gray-600');
            } else if (step3Header) {
                step3Header.querySelector('div').innerHTML = '3';
            }
        }


        function validateStep(step) {
            let isValid = true;
            if (step === 1) {
                const currentStepInputs = document.querySelectorAll('#step-1-content input[required], #step-1-content select[required]');
                currentStepInputs.forEach(input => {
                    if (!input.value.trim()) {
                        isValid = false;
                        input.classList.add('border-red-500');
                    } else {
                        input.classList.remove('border-red-500');
                    }
                });
                if (!isValid) {
                    showNotification('Por favor, completa todos los campos obligatorios.', 'error');
                }
            }
            return isValid;
        }

        stickyReserveBtn.addEventListener('click', function() {
            if (currentStep === 1) {
                if (validateStep(1)) {
                    currentStep = 2;
                    updateStepVisibility();
                    form.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
            } else if (currentStep === 2) {
                const selectedPaymentOption = document.querySelector('.payment-option.selected');
                if (!selectedPaymentOption) {
                    showNotification('Por favor, selecciona un mÃ©todo de pago.', 'error');
                    return;
                }
                const paymentType = selectedPaymentOption.dataset.payment;
                if (paymentType === 'crypto') {
                    openCryptoCheckout();
                } else if (paymentType === 'whatsapp') {
                    showDevelopmentPopup(() => {
                        window.open('https://wa.me/5804243156057?text=Hola, quisiera proceder con mi reserva.', '_blank');
                        setTimeout(() => { currentStep = 3; updateStepVisibility(); }, 2000);
                    });
                } else if (paymentType === 'card') {
                    showDevelopmentPopup(() => {
                        window.open('https://link.mercadopago.cl/guacamayatravels', '_blank');
                         setTimeout(() => { currentStep = 3; updateStepVisibility(); }, 2000);
                    });
                }
            }
        });


        if (prevStepBtn) {
            prevStepBtn.addEventListener('click', function() {
                if (currentStep === 2) {
                    currentStep = 1;
                    updateStepVisibility();
                }
            });
        }

        const paymentOptionsContainer = document.getElementById('payment-options-container');
        if (paymentOptionsContainer) {
            paymentOptionsContainer.addEventListener('click', function(event) {
                const selectedOption = event.target.closest('.payment-option');
                if (selectedOption) {
                    document.querySelectorAll('.payment-option').forEach(option => {
                        option.classList.remove('selected');
                    });
                    selectedOption.classList.add('selected');
                }
            });
        }

        if (form) {
            form.addEventListener('submit', function(event) {
                event.preventDefault();
            });
        }

        const cryptoWallets = [
            { name: 'Bitcoin (BTC)', address: 'bc1qxy2kgdygjrsqtzq2n0yrf2493p83kkfjhx0wlh', logo: 'https://www.bybit.com/bycsi-root/assets/image/coins/light/btc.svg?quality=63&format=avif&resize=width/50.4' },
            { name: 'Ethereum (ETH)', address: '0x1234567890123456789012345678901234567890', logo: 'https://www.bybit.com/bycsi-root/assets/image/coins/light/eth.svg?quality=63&format=avif&resize=width/50.4' },
            { name: 'USDT (Tether)', address: '0xabcdef1234567890abcdef1234567890abcdef12', logo: 'https://www.bybit.com/bycsi-root/app/assets/token/f904fc2c215f7f86cea97f5b562217ad.svg' },
            { name: 'Solana (SOL)', address: 'So11111111111111111111111111111111111111112', logo: 'https://www.bybit.com/bycsi-root/assets/image/coins/light/sol.svg?quality=63&format=avif&resize=width/50.4' },
            { name: 'USD Coin (USDC)', address: '0xa0b86991c6218b36c1d19d4a2e9eb0ce3606eb48', logo: 'https://cryptoindex.com/pic/coins/usdc.svg' },
        ];

        function openCryptoCheckout() {
            mainContent.classList.add('hidden');
            if(form) form.classList.add('hidden');
            cryptoCheckoutSection.classList.remove('hidden');
            stickyReserveBtnContainer.classList.add('hidden');
            window.scrollTo({ top: 0, behavior: 'smooth' });

            const walletsContainer = cryptoCheckoutSection.querySelector('#crypto-wallets-list');
            const qrCodeImg = cryptoCheckoutSection.querySelector('#crypto-qr-code-img');
            
            walletsContainer.innerHTML = cryptoWallets.map(wallet => `
                <div class="bg-white p-3 rounded-lg border flex items-center gap-4">
                    <img src="${wallet.logo}" alt="${wallet.name}" class="w-8 h-8">
                    <div class="flex-grow">
                        <p class="text-sm font-semibold text-gray-700">${wallet.name}</p>
                        <p class="text-xs text-gray-500 break-all">${wallet.address}</p>
                    </div>
                    <button class="copy-btn p-2 rounded-md hover:bg-gray-200" data-address="${wallet.address}">
                        <i class="far fa-copy"></i>
                    </button>
                </div>
            `).join('');
            qrCodeImg.src = `https://api.qrserver.com/v1/create-qr-code/?size=180x180&data=${cryptoWallets[0].address}`;
        }

        if(closeCryptoCheckoutBtn) {
            closeCryptoCheckoutBtn.addEventListener('click', function() {
                cryptoCheckoutSection.classList.add('hidden');
                mainContent.classList.remove('hidden');
                currentStep = 2;
                updateStepVisibility();
            });
        }
        
        if(cryptoCheckoutSection) {
            cryptoCheckoutSection.addEventListener('click', function(e) {
                const copyBtn = e.target.closest('.copy-btn');
                if (copyBtn) {
                    const address = copyBtn.dataset.address;
                    const textArea = document.createElement("textarea");
                    textArea.value = address;
                    document.body.appendChild(textArea);
                    textArea.select();
                    try {
                        document.execCommand('copy');
                        showNotification('Â¡DirecciÃ³n copiada al portapapeles!', 'success');
                    } catch (err) {
                        console.error('No se pudo copiar la direcciÃ³n: ', err);
                    }
                    document.body.removeChild(textArea);
                }
            });
        }

        if (paymentReceivedBtn) {
            paymentReceivedBtn.addEventListener('click', function() {
                paymentReceivedBtn.disabled = true;
                paymentValidationMessage.classList.remove('hidden');
                let timeLeft = 10;
                countdownTimerDisplay.textContent = `${timeLeft} segundos`;

                const countdownInterval = setInterval(() => {
                    timeLeft--;
                    countdownTimerDisplay.textContent = `${timeLeft} segundos`;
                    if (timeLeft <= 0) {
                        clearInterval(countdownInterval);
                        paymentValidationMessage.textContent = 'Pago validado.';
                        showNotification('Â¡Pago validado con Ã©xito!', 'success');
                        currentStep = 3;
                        updateStepVisibility();
                        paymentReceivedBtn.disabled = false;
                    }
                }, 1000);
            });
        }

        function generateBookingNumber() {
            const characters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let result = '';
            for (let i = 0; i < 10; i++) {
                result += characters.charAt(Math.floor(Math.random() * characters.length));
            }
            return result;
        }

        function generateConfirmationId() {
            const characters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let result = '';
            for (let i = 0; i < 8; i++) {
                result += characters.charAt(Math.floor(Math.random() * characters.length));
            }
            return result;
        }

        function generateAndDisplayBookingInfo() {
            if (bookingNumberElement) bookingNumberElement.textContent = generateBookingNumber();
            if (confirmationIdElement) confirmationIdElement.textContent = generateConfirmationId();
        }

        function startRedirectCountdown() {
            let secondsToRedirect = 6;
            redirectCountdownElement.textContent = secondsToRedirect;

            const redirectInterval = setInterval(() => {
                secondsToRedirect--;
                redirectCountdownElement.textContent = secondsToRedirect;
                if (secondsToRedirect <= 0) {
                    clearInterval(redirectInterval);
                    window.location.href = 'index.html';
                }
            }, 1000);
        }

        if (dateDisplayBlock) {
            dateDisplayBlock.addEventListener('click', () => {
                calendarModal.classList.remove('hidden');
                calendarModal.classList.add('visible');
                renderCalendar();
            });
        }
        if (closeCalendarBtn) closeCalendarBtn.addEventListener('click', () => {
            calendarModal.classList.remove('visible');
            calendarModal.classList.add('hidden');
            updateDateDisplayInSummary();
            updatePriceSummary();
        });
        if (closeCalendarModalX) closeCalendarModalX.addEventListener('click', () => {
            calendarModal.classList.remove('visible');
            calendarModal.classList.add('hidden');
        });
        if (clearDatesBtn) clearDatesBtn.addEventListener('click', () => {
            selectedDeparture = null;
            selectedReturn = null;
            renderCalendar();
            updateCalendarSelection();
        });
        if (prevMonthBtn) prevMonthBtn.addEventListener('click', () => {
            currentMonthDate.setMonth(currentMonthDate.getMonth() - 1);
            renderCalendar();
        });
        if (nextMonthBtn) nextMonthBtn.addEventListener('click', () => {
            currentMonthDate.setMonth(currentMonthDate.getMonth() + 1);
            renderCalendar();
        });
        if (tonightBtn) tonightBtn.addEventListener('click', () => {
            const today = new Date();
            const tomorrow = new Date();
            tomorrow.setDate(today.getDate() + 1);
            selectedDeparture = today;
            selectedReturn = tomorrow;
            updateCalendarSelection();
        });
        if (nextWeekendBtn) nextWeekendBtn.addEventListener('click', () => {
            const today = new Date();
            const dayOfWeek = today.getDay();
            const daysUntilFriday = (5 - dayOfWeek + 7) % 7;
            const nextFriday = new Date(today);
            nextFriday.setDate(today.getDate() + daysUntilFriday);
            const nextSunday = new Date(nextFriday);
            nextSunday.setDate(nextFriday.getDate() + 2);
            selectedDeparture = nextFriday;
            selectedReturn = nextSunday;
            updateCalendarSelection();
        });

        function renderCalendar() {
            if (!calendarMonthsContainer) return;
            calendarMonthsContainer.innerHTML = '';
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            calendarMonthYear.textContent = currentMonthDate.toLocaleDateString('es-ES', { month: 'long', year: 'numeric' });

            const monthsToShow = window.innerWidth < 768 ? 1 : 2;

            for (let i = 0; i < monthsToShow; i++) {
                const monthDate = new Date(currentMonthDate.getFullYear(), currentMonthDate.getMonth() + i, 1);
                if (monthsToShow > 1) {
                    const monthTitle = document.createElement('h4');
                    monthTitle.className = 'font-semibold text-center mb-2';
                    monthTitle.textContent = monthDate.toLocaleDateString('es-ES', { month: 'long', year: 'numeric' });
                    calendarMonthsContainer.appendChild(monthTitle);
                }
                
                const gridEl = document.createElement('div');
                gridEl.className = 'calendar-grid';
                ['D', 'L', 'M', 'X', 'J', 'V', 'S'].forEach(day => gridEl.innerHTML += `<div class="calendar-day weekday">${day}</div>`);

                let firstDayOfMonth = monthDate.getDay();
                firstDayOfMonth = (firstDayOfMonth === 0) ? 6 : firstDayOfMonth - 1;
                
                for (let j = 0; j < firstDayOfMonth; j++) gridEl.appendChild(document.createElement('div'));

                const daysInMonth = new Date(monthDate.getFullYear(), monthDate.getMonth() + 1, 0).getDate();
                for (let day = 1; day <= daysInMonth; day++) {
                    const dayEl = document.createElement('div');
                    const dayDate = new Date(monthDate.getFullYear(), monthDate.getMonth(), day);
                    dayEl.className = 'calendar-day';
                    dayEl.textContent = day;
                    dayEl.dataset.date = dayDate.toISOString().split('T')[0];

                    const rand = Math.random();
                    if (rand < 0.3) dayEl.classList.add('price-cheap'); else if (rand < 0.7) dayEl.classList.add('price-medium'); else dayEl.classList.add('price-expensive');

                    if (dayDate < today) {
                        dayEl.classList.add('disabled');
                    } else {
                        dayEl.addEventListener('click', () => handleDateClick(dayDate));
                    }
                    gridEl.appendChild(dayEl);
                }
                calendarMonthsContainer.appendChild(gridEl);
            }
            updateCalendarSelection();
        }

        function handleDateClick(date) {
            if (!selectedDeparture || (selectedDeparture && selectedReturn)) {
                selectedDeparture = date;
                selectedReturn = null;
            } else if (date < selectedDeparture) {
                selectedDeparture = date;
            } else {
                selectedReturn = date;
            }
            updateCalendarSelection();
        }

        function updateCalendarSelection() {
            const formatOptions = { weekday: 'short', day: 'numeric', month: 'short' };
            if(calendarCheckinDisplay) calendarCheckinDisplay.textContent = selectedDeparture ? selectedDeparture.toLocaleDateString('es-ES', formatOptions) : '--';
            if(calendarCheckoutDisplay) calendarCheckoutDisplay.textContent = selectedReturn ? selectedReturn.toLocaleDateString('es-ES', formatOptions) : '--';

            document.querySelectorAll('.calendar-day[data-date]').forEach(day => {
                day.classList.remove('selected', 'in-range', 'range-start', 'range-end');
                const dayDate = new Date(day.dataset.date + 'T00:00:00');
                if (selectedDeparture && day.dataset.date === selectedDeparture.toISOString().split('T')[0]) day.classList.add('selected', 'range-start');
                if (selectedReturn && day.dataset.date === selectedReturn.toISOString().split('T')[0]) day.classList.add('selected', 'range-end');
                if (selectedDeparture && selectedReturn && dayDate > selectedDeparture && dayDate < selectedReturn) day.classList.add('in-range');
            });
        }

        function updateDateDisplayInSummary() {
            const formatOptionsDate = { weekday: 'short', day: 'numeric', month: 'long' };
            
            if (selectedDeparture) {
                document.getElementById('display-checkin-date').textContent = selectedDeparture.toLocaleDateString('es-ES', formatOptionsDate);
            }
            if (selectedReturn) {
                document.getElementById('display-checkout-date').textContent = selectedReturn.toLocaleDateString('es-ES', formatOptionsDate);
            }
            
            const nights = calculateNights(selectedDeparture, selectedReturn);
            document.getElementById('display-nights').textContent = nights;
        }
        
        const specialRequestsFieldset = document.querySelector('fieldset[aria-label="Solicitudes especiales"]');
        if (specialRequestsFieldset) {
            specialRequestsFieldset.addEventListener('change', function(event) {
                const summaryBedType = document.getElementById('summary-bed-type');
                if (event.target.name === 'fumadores') {
                    const camaGrandeRadio = document.getElementById('cama-grande');
                    if (camaGrandeRadio) {
                        camaGrandeRadio.checked = true;
                        summaryBedType.textContent = "1 cama doble";
                    }
                }
                if (event.target.name === 'camas') {
                    summaryBedType.textContent = event.target.nextElementSibling.textContent.trim();
                }
            });
        }
        
        const hamburgerBtn = document.getElementById('hamburger-btn');
        const mobileMenu = document.getElementById('mobile-menu');
        const closeMobileMenuBtn = document.getElementById('close-mobile-menu');
        const mobileMenuOverlay = document.getElementById('mobile-menu-overlay');

        function openMenu() {
            if (mobileMenu && mobileMenuOverlay) {
                mobileMenu.classList.remove('-translate-x-full');
                mobileMenuOverlay.classList.remove('hidden');
            }
        }

        function closeMenu() {
            if (mobileMenu && mobileMenuOverlay) {
                mobileMenu.classList.add('-translate-x-full');
                mobileMenuOverlay.classList.add('hidden');
            }
        }

        if (hamburgerBtn) {
            hamburgerBtn.addEventListener('click', openMenu);
        }
        if (closeMobileMenuBtn) {
            closeMobileMenuBtn.addEventListener('click', closeMenu);
        }
        if (mobileMenuOverlay) {
            mobileMenuOverlay.addEventListener('click', closeMenu);
        }

        // --- INITIALIZATION ---
        const initialBookingDetails = getBookingDetailsFromSession();
        populatePage(initialBookingDetails);
        updateStepVisibility();
        startTimer();
        renderAuthStatus();
    });
</script>
</html>

